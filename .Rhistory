ar_part=ar1*ts_var[i-1]+ar2*ts_var[i-2]+ar3*ts_var[i-3]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
lim_max=max(max(man_pred,na.rm=TRUE),max(fitted(tv_arima),na.rm=TRUE))
lim_min=min(min(man_pred,na.rm=TRUE),min(fitted(tv_arima),na.rm=TRUE))
qplot(man_pred,fitted(tv_arima),xlim=c(lim_min,lim_max),ylim=c(lim_min,lim_max))
man_fit=lm(man_pred~fitted(tv_arima))
summary(man_fit)
coef(man_fit)
qplot(study_var,fitted(poly_fit))+theme_bw()+ggtitle("2nd order Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,fitted(stepwise_model))+theme_bw()+ggtitle("Stepwise Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,as.vector(fitted(tv_arima)))+theme_bw()+ggtitle("ARIMAX Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
study_var=channel_sessions_long$direct.net.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Direct Net Home"
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
study_var=channel_sessions_long$direct.net.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Direct Net Home"
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=stl(ts_var, s.window="periodic",robust=TRUE)
plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
tmp_df=rbind(tmp_df,tv_arima_R2)
pander(tmp_df)
round(cor(fitted(tv_arima),ts_var)^2,2)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
ar1=coef(tv_arima)[grep("ar1",names(coef(tv_arima)))]
ar2=coef(tv_arima)[grep("ar2",names(coef(tv_arima)))]
ar3=coef(tv_arima)[grep("ar3",names(coef(tv_arima)))]
tv_coef=coef(tv_arima)[grep("tv",names(coef(tv_arima)))]
e_terms=3
man_pred=rep(NA,length(ts_var))
man_pred[1:e_terms]=fitted(tv_arima)[1:e_terms]
for (i in (e_terms+1):length(ts_var)){
exo_part=tv_coef*(tv[i]-ar1*tv[i-1]-ar2*tv[i-2]-ar3*tv[i-3])
ar_part=ar1*ts_var[i-1]+ar2*ts_var[i-2]+ar3*ts_var[i-3]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
lim_max=max(max(man_pred,na.rm=TRUE),max(fitted(tv_arima),na.rm=TRUE))
lim_min=min(min(man_pred,na.rm=TRUE),min(fitted(tv_arima),na.rm=TRUE))
qplot(man_pred,fitted(tv_arima),xlim=c(lim_min,lim_max),ylim=c(lim_min,lim_max))
man_fit=lm(man_pred~fitted(tv_arima))
summary(man_fit)
coef(man_fit)
qplot(study_var,fitted(poly_fit))+theme_bw()+ggtitle("2nd order Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,fitted(stepwise_model))+theme_bw()+ggtitle("Stepwise Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,as.vector(fitted(tv_arima)))+theme_bw()+ggtitle("ARIMAX Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
study_var=channel_sessions_long$direct.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Direct Home"
#frequency shoud be 52 (weeks per year), but we don't have two full periods
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=stl(ts_var, s.window="periodic",robust=TRUE)
plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
ar1=coef(tv_arima)[grep("ar1",names(coef(tv_arima)))]
tv_coef=coef(tv_arima)[grep("tv",names(coef(tv_arima)))]
e_terms=1
man_pred=rep(NA,length(study_var))
man_pred[1:e_terms]=study_var[1:e_terms]
for (i in (e_terms+1):length(study_var)){
exo_part=tv_coef*(tv[i]-ar1*tv[i-1])
ar_part=ar1*ts_var[i-1]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
lim_max=max(max(man_pred,na.rm=TRUE),max(fitted(tv_arima),na.rm=TRUE))
lim_min=min(min(man_pred,na.rm=TRUE),min(fitted(tv_arima),na.rm=TRUE))
qplot(man_pred,fitted(tv_arima),xlim=c(lim_min,lim_max),ylim=c(lim_min,lim_max))
man_fit=lm(man_pred~fitted(tv_arima))
summary(man_fit)
coef(man_fit)
qplot(study_var,fitted(poly_fit))+theme_bw()+ggtitle("2nd order Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,fitted(stepwise_model))+theme_bw()+ggtitle("Stepwise Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,as.vector(fitted(tv_arima)))+theme_bw()+ggtitle("ARIMAX Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
study_var=channel_sessions_long$paid.brand.sessions
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Paid Brand"
#frequency shoud be 52 (weeks per year), but we don't have two full periods
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=try(stl(ts_var, s.window="periodic",robust=TRUE))
if (class(stl_obj)!="try-error") plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
ma1=coef(tv_arima)[grep("ma1",names(coef(tv_arima)))]
ar1=coef(tv_arima)[grep("ar1",names(coef(tv_arima)))]
tv_coef=coef(tv_arima)[grep("tv",names(coef(tv_arima)))]
e_terms=2
man_pred=rep(NA,length(study_var))
man_pred[1:e_terms]=study_var[1:e_terms]
for (i in (e_terms+1):length(study_var)){
e_1=study_var[i-1]-man_pred[i-1]; if (sum(e_1)==0) e_1=0 else if (is.na(e_1)) e_1=0
ma_part=ma1*e_1
exo_part=tv_coef*(tv[i]-tv[i-1]-ar1*(tv[i-1]-tv[i-2]))
ar_part=study_var[i-1]+ar1*(study_var[i-1]-study_var[i-2])
man_pred[i]=ar_part+ma_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
lim_max=max(max(man_pred,na.rm=TRUE),max(fitted(tv_arima),na.rm=TRUE))
lim_min=min(min(man_pred,na.rm=TRUE),min(fitted(tv_arima),na.rm=TRUE))
qplot(man_pred,fitted(tv_arima),xlim=c(lim_min,lim_max),ylim=c(lim_min,lim_max))
man_fit=lm(man_pred~fitted(tv_arima))
summary(man_fit)
coef(man_fit)
qplot(study_var,fitted(poly_fit))+theme_bw()+ggtitle("2nd order Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,fitted(stepwise_model))+theme_bw()+ggtitle("Stepwise Polynomial Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
qplot(study_var,as.vector(fitted(tv_arima)))+theme_bw()+ggtitle("ARIMAX Fit")+
xlab(paste(title_paste,"Sessions"))+ylab("Fitted Values")
study_var=channel_sessions_long$organic.net.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Organic Net Home"
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=stl(ts_var, s.window="periodic",robust=TRUE)
plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(study_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean = FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
ma1=coef(tv_arima)[grep("ma1",names(coef(tv_arima)))]
ma2=coef(tv_arima)[grep("ma2",names(coef(tv_arima)))]
ar1=coef(tv_arima)[grep("ar1",names(coef(tv_arima)))]
tv_coef=coef(tv_arima)[grep("tv",names(coef(tv_arima)))]
e_terms=2
man_pred=rep(NA,length(study_var))
man_pred[1:e_terms]=study_var[1:e_terms]
e_terms=2
man_pred=rep(NA,length(study_var))
man_pred[1:e_terms]=study_var[1:e_terms]
for (i in (e_terms+1):length(study_var)){
e_1=study_var[i-1]-man_pred[i-1]; if (sum(e_1)==0) e_1=0 else if (is.na(e_1)) e_1=0
e_2=study_var[i-2]-man_pred[i-2]; if (sum(e_2)==0) e_2=0 else if (is.na(e_2)) e_2=0
ma_part=ma1*e_1+ma2*e_2
exo_part=tv_coef*(tv[i]-tv[i-1]-ar1*(tv[i-1]-tv[i-2]))
ar_part=study_var[i-1]+ar1*(study_var[i-1]-study_var[i-2])
man_pred[i]=ar_part+ma_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
lim_max=max(max(man_pred,na.rm=TRUE),max(fitted(tv_arima),na.rm=TRUE))
lim_min=min(min(man_pred,na.rm=TRUE),min(fitted(tv_arima),na.rm=TRUE))
qplot(man_pred,fitted(tv_arima),xlim=c(lim_min,lim_max),ylim=c(lim_min,lim_max))
man_fit=lm(man_pred~fitted(tv_arima))
summary(man_fit)
coef(man_fit)
pander(tmp_df)
summary(tv_arima)
man_pred[1:20]
study_var=channel_sessions_long$organic.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Organic Home"
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
study_var=channel_sessions_long$organic.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Organic Home"
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
```
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=stl(ts_var, s.window="periodic",robust=TRUE)
plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
ar1=coef(tv_arima)[grep("ar1",names(coef(tv_arima)))]
ar2=coef(tv_arima)[grep("ar2",names(coef(tv_arima)))]
ar3=coef(tv_arima)[grep("ar3",names(coef(tv_arima)))]
tv_coef=coef(tv_arima)[grep("tv",names(coef(tv_arima)))]
e_terms=3
man_pred=rep(NA,length(ts_var))
man_pred[1:e_terms]=fitted(tv_arima)[1:e_terms]
for (i in (e_terms+1):length(ts_var)){
exo_part=tv_coef*(tv[i]-ar1*tv[i-1]-ar2*tv[i-2]-ar3*tv[i-3])
ar_part=ar1*ts_var[i-1]+ar2*ts_var[i-2]+ar3*ts_var[i-3]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
lim_max=max(max(man_pred,na.rm=TRUE),max(fitted(tv_arima),na.rm=TRUE))
lim_min=min(min(man_pred,na.rm=TRUE),min(fitted(tv_arima),na.rm=TRUE))
qplot(man_pred,fitted(tv_arima),xlim=c(lim_min,lim_max),ylim=c(lim_min,lim_max))
e_terms=3
man_pred=rep(NA,length(study_var))
man_pred[1:e_terms]=study_var[1:e_terms]
for (i in (e_terms+1):length(ts_var)){
exo_part=tv_coef*(tv[i]-ar1*tv[i-1]-ar2*tv[i-2]-ar3*tv[i-3])
ar_part=ar1*ts_var[i-1]+ar2*ts_var[i-2]+ar3*ts_var[i-3]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
study_var=channel_sessions_long$direct.net.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Direct Net Home"
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
#This plot shows a major time trend component- implying previous models were useless
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=stl(ts_var, s.window="periodic",robust=TRUE)
plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
ar1=coef(tv_arima)[grep("ar1",names(coef(tv_arima)))]
ar2=coef(tv_arima)[grep("ar2",names(coef(tv_arima)))]
ar3=coef(tv_arima)[grep("ar3",names(coef(tv_arima)))]
tv_coef=coef(tv_arima)[grep("tv",names(coef(tv_arima)))]
e_terms=3
man_pred=rep(NA,length(ts_var))
man_pred[1:e_terms]=fitted(tv_arima)[1:e_terms]
for (i in (e_terms+1):length(ts_var)){
exo_part=tv_coef*(tv[i]-ar1*tv[i-1]-ar2*tv[i-2]-ar3*tv[i-3])
ar_part=ar1*ts_var[i-1]+ar2*ts_var[i-2]+ar3*ts_var[i-3]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
e_terms=3
man_pred=rep(NA,length(study_var))
man_pred[1:e_terms]=study_var[1:e_terms]
for (i in (e_terms+1):length(study_var)){
exo_part=tv_coef*(tv[i]-ar1*tv[i-1]-ar2*tv[i-2]-ar3*tv[i-3])
ar_part=ar1*study_var[i-1]+ar2*study_var[i-2]+ar3*study_var[i-3]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
study_var=channel_sessions_long$direct.home
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Direct Home"
#frequency shoud be 52 (weeks per year), but we don't have two full periods
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=stl(ts_var, s.window="periodic",robust=TRUE)
plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
ar1=coef(tv_arima)[grep("ar1",names(coef(tv_arima)))]
tv_coef=coef(tv_arima)[grep("tv",names(coef(tv_arima)))]
e_terms=1
man_pred=rep(NA,length(study_var))
man_pred[1:e_terms]=study_var[1:e_terms]
for (i in (e_terms+1):length(study_var)){
exo_part=tv_coef*(tv[i]-ar1*tv[i-1])
ar_part=ar1*ts_var[i-1]
man_pred[i]=ar_part+exo_part
}
man_pred[1:20]
fitted(tv_arima)[1:20]
lim_max=max(max(man_pred,na.rm=TRUE),max(fitted(tv_arima),na.rm=TRUE))
lim_min=min(min(man_pred,na.rm=TRUE),min(fitted(tv_arima),na.rm=TRUE))
qplot(man_pred,fitted(tv_arima),xlim=c(lim_min,lim_max),ylim=c(lim_min,lim_max))
man_fit=lm(man_pred~fitted(tv_arima))
summary(man_fit)
coef(man_fit)
study_var=channel_sessions_long$paid.brand.sessions
na_inds=which(is.na(study_var))
tv=channel_sessions_long$tv.spend[-na_inds]
study_var=na.omit(study_var)
title_paste="Paid Brand"
ts_var=ts(study_var, frequency = 52)
poly_fit=lm(study_var~tv+I(tv^2))
tmp_df=data.frame(round(coef(poly_fit),3))
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
tmp_df=rbind(tmp_df,cor(fitted(poly_fit),na.omit(study_var))^2)
pander(tmp_df)
big_poly_fit=lm(study_var~tv+I(tv^2)+I(tv^3)+I(tv^4))
stepwise_model=step(big_poly_fit,k=log(nrow(channel_sessions_long)),scope = list(lower = ~tv))
tmp_df=data.frame(round(coef(stepwise_model),3))
tmp_df=rbind(tmp_df,cor(fitted(stepwise_model),na.omit(study_var))^2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
tmp_df=data.frame(tv.spend=tv,channel=study_var,poly=fitted(poly_fit),
step=fitted(stepwise_model))
ggplot(tmp_df) + theme_bw()+
geom_point(aes(x=tv.spend,y=channel,color=title_paste))+
geom_line(aes(x=tv.spend,y=poly,color="2nd Order Plynomial Fit"))+
geom_line(aes(x=tv.spend,y=step,color="Stepwise Polynomial Fit"))+
ggtitle("Model Fits")+xlab("TV Speding (Dollars)")+ylab("Sessions")+
guides(color=guide_legend(title="Models"))
qplot(channel_sessions_long$date[-na_inds],stepwise_model$residuals)+theme_bw()+
ggtitle("Polynomial Fit Residuals")+xlab("Date")+ylab("Residuals")
stl_obj=try(stl(ts_var, s.window="periodic",robust=TRUE))
if (class(stl_obj)!="try-error") plot(stl_obj)+title(paste(title_paste,"Seasonal Trend Decomposition"))
tv_arima=auto.arima(ts_var,xreg=c(tv),max.P=0,max.D = 0,max.Q = 0,allowdrift=FALSE,allowmean=FALSE)
summary(tv_arima)
tv_arima_R2=round(cor(fitted(tv_arima),ts_var)^2,2)
tmp_df=data.frame(coef(tv_arima))
tmp_df=rbind(tmp_df,tv_arima_R2)
rownames(tmp_df)[length(rownames(tmp_df))]="R2"
pander(tmp_df)
summary(tv_arima)
tv_arima_fcast=forecast(tv_arima,xreg=c(tv),h=0)
plot(tv_arima_fcast)
mean(tv)
